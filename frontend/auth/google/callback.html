<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Google OAuth Callback</title>
  </head>
  <body>
    <script>
      const API_BASE_URL = "http://localhost:8001/api/auth"; // Handle Google callback immediately
      window.addEventListener("load", async function () {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get("code");
        const state = urlParams.get("state");
        const error = urlParams.get("error");
        const errorDescription = urlParams.get("error_description");

        if (error) {
          showError(
            `Google authentication failed: ${errorDescription || error}`
          );
          return;
        }

        if (!code) {
          showError("Authorization code not received from Google");
          return;
        }

        try {
          console.log("Processing Google OAuth callback...");

          // Send code to backend for processing
          const response = await fetch(
            `${API_BASE_URL}/auth/google/callback/`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                code: code,
                state: state,
              }),
            }
          );

          const data = await response.json();

          if (response.ok) {
            // Store authentication data
            const userData = {
              id: data.user_id || data.user.id,
              username: data.username || data.user.username || data.user.name,
              email: data.email || data.user.email,
              phone_verified:
                data.phone_verified || data.user.phone_verified || false,
              login_method: "google",
            };
            
            console.log("=== GOOGLE LOGIN SUCCESS ===");
            console.log("Token:", data.token ? "Received ✓" : "Missing ✗");
            console.log("User Data:", userData);
            console.log("Saving to localStorage...");
            
            localStorage.setItem("authToken", data.token);
            localStorage.setItem("currentUser", JSON.stringify(userData));
            localStorage.removeItem("google_state");

            console.log("Verification - Token in localStorage:", localStorage.getItem("authToken") ? "✓" : "✗");
            console.log("Verification - User in localStorage:", localStorage.getItem("currentUser") ? "✓" : "✗");
            console.log("============================");

            // Dispatch auth state change event for any listening components
            try {
              console.log("Dispatching authStateChanged event...");
              window.dispatchEvent(
                new CustomEvent("authStateChanged", {
                  detail: {
                    isAuthenticated: true,
                    user: userData,
                    token: data.token,
                  },
                })
              );
              console.log("Event dispatched successfully ✓");
            } catch (e) {
              console.error("Could not dispatch authStateChanged event:", e);
            }

            // Check if this is a signup flow
            const isSignup = state && state.startsWith("signup_");

            // Small delay to allow localStorage to persist
            setTimeout(() => {
              console.log("Redirecting to:", isSignup ? "onboarding" : "home");
              if (isSignup) {
                // Redirect to onboarding for new users
                window.location.href = "http://localhost:3000/frontend/onboarding.html";
              } else {
                // Redirect to home page for existing users
                window.location.href = "http://localhost:3000/frontend/index.html";
              }
            }, 300);
          } else {
            throw new Error(data.error || "Authentication failed");
          }
        } catch (error) {
          console.error("Google callback error:", error);
          showError(`Login failed: ${error.message}`);
        }
      });

      function showError(message) {
        const alertDiv = document.createElement("div");
        alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #dc3545;
                color: white;
                padding: 15px 25px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                font-family: Arial, sans-serif;
                font-size: 14px;
                max-width: 400px;
                text-align: center;
            `;
        alertDiv.innerHTML = `
                <strong>Authentication Error</strong><br>
                ${message}<br><br>
                <button onclick="window.location.href='../../login.html'" style="
                    background: white;
                    color: #dc3545;
                    border: none;
                    padding: 8px 16px;
                    border-radius: 4px;
                    cursor: pointer;
                    font-weight: bold;
                ">Back to Login</button>
            `;
        document.body.appendChild(alertDiv);
      }
    </script>
  </body>
</html>
